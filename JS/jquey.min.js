function isNumeric(v){
   var reg = /^[0-9]*$/;
   return reg.test(v); 
}
function _dateTimeFormat(t) {
	if (t.length>=14)
		return t.substring(0,4)+"/"+t.substring(4,6)+"/"+t.substring(6,8)+" "+t.substring(8,10)+":"+t.substring(10,12)+":"+t.substring(12,14);
	else
		return t;
}
function _timeFormat(t) {
	if (t.length>=14)
		return t.substring(4,6)+"/"+t.substring(6,8)+" "+t.substring(8,10)+":"+t.substring(10,12)+":"+t.substring(12,14);
	else
		return t;
}
function _dateFormat(d) {
	if (d.length>=8)
		return d.substring(0,4)+"/"+d.substring(4,6)+"/"+d.substring(6,8);
	else
		return d.substring(0,10);
}
function _getDateID(dt) {
	return dt.getFullYear()*10000+(dt.getMonth()+1)*100+dt.getDate();
}
var langU ="tw";
var week = new Array("日","一","二","三","四","五","六");
var week_en = new Array("Su", "Mo", "Tu", "We", "Th", "Fr", "Sa");
var pms=["ATM/轉帳","1","Paypal","通路代收","其他付款方式","5","支付寶"];
var pmens=["ATM","1","Paypal","by Agency","其他付款方式","5","Alipay"];
var sDate;
var eDate;
var isDate;
var dayAmount;
var startAmount=0;
var _ServletPath="http://www.kitravel.com.tw/servlet/hk.";
var hotelID=0;
var agentID=0;
var hotel;
var agent=null;
var step=1;
var roomList;
var roomNameArray = new Array();
var daily_array;
var nowPage=0;
var choosedDate=0;
var totalSteps=0;
var carts=null;
var checkinDID="";
var checkoutDID="";
var total_fee=0;
var payMethod;
var orderNote;
var freeIcon=location.pathname.split("/")[2];
var packageArray=new Array();
var payMethods="";
var hadPackages=false;
var arrivalDate="";
var arrivalTime="";
var payMObj=null;
var lockSubmit=false;
var _payOtherUrl="";

function showCloseB() {
  if ($("#closePaypal")) {
    $("#closePaypal").show();
  }
}
function finalRes(res) {
  console.log(res);
  //$('#processing-modal').modal("hide");
  $("#btnNext").hide();
  lockSubmit=false;
  waitingDialog.hide();
  if (res==-3) {
		alert(imsgs(4));
		slide('page1', null);
		return;
	} else if (res==-2) {
		alert(imsgs(5));
		return;
	}
  
  $("#stepbuttons").hide();
  
  var finalInfo=res.split(",");
	if (finalInfo.length>1) {
		if (payMethod==0) {
      goStep(totalSteps+1);
			$('#final_ORDER_NO').html(finalInfo[6]);
			$('#final_ORDER_BANK').html(hotel.bank+"<br> ("+hotel.bankCode+")");
			var accountInfo="";
			if (hotel.accountName.length>0)
				accountInfo="戶名:"+hotel.accountName+"<br>";
			accountInfo+=finalInfo[1];
			$('#final_ORDER_ACCOUNT').html(accountInfo);
			$('#final_ORDER_PAY').html(hotel.currency+" "+finalInfo[3]);
			$('#final_ORDER_LIMIT').html(finalInfo[2]);
    } else if (payMethod==3) {
      $('#agencyFinishModal').modal('show');
      $('#bnbOrderNo').html(finalInfo[1]);
      $('#bnbOrderNoE').html(finalInfo[1]);
		} else if (payMethod==6) { //alipay
      goStep(totalSteps+2);
			var pageURL=window.location.href.toString();
			alert(imsgs(0)+finalInfo[1]);
			alert(imsgs(1));
			location.reload();
			//top.location.replace( _ServletPath + "PayPalSend?no=" + finalInfo[1] + "&hid=" + hotelID + "&returl=" + pageURL + "&lang=" + langU);
		} else if (payMethod==2) { //paypal
      //alert("請注意, 收費單位將開新的彈出視窗, 若出現封鎖彈跳視窗的警訊時, 請選擇信任本網站讓視窗能正常出現。");
      goStep(totalSteps+2);
			var pageURL=window.location.href.toString();
      var uu=_ServletPath + "PayPalSend?no=" + finalInfo[1] + "&hid=" + hotelID + "&returl=" + pageURL + "&lang=" + langU;
      $("body").append("<div id='GoPaypal' class='modal fade bs-example-modal-sm' tabindex='-1' role='dialog' aria-labelledby='mySmallModalLabel' aria-hidden='true'><div class='modal-dialog modal-sm'><div class='modal-content'>"
      +"<div class='modal-header'><h4 class='modal-title' id='mySmallModalLabel'>"+imsgs(6)+"</h4></div><div class='modal-footer'><a class='btn btn-warning' role='button' href='"+uu+"' target='_blank' onclick='showCloseB()'>"+imsgs(7)+"</a><div id='closePaypal' style='display:none;'><br><button type='button' class='btn btn-default' onclick='location.reload();'>若已完成付款請點我或點上方按鈕付款。</button></div></div></div></div></div>");
      $("#GoPaypal").modal({backdrop:'static'});
      $("#GoPaypal").modal("show");
			//window.open(_ServletPath + "PayPalSend?no=" + finalInfo[1] + "&hid=" + hotelID + "&returl=" + pageURL + "&lang=" + langU);
    } else if (payMethod==11 || finalInfo[10]=="hint") { //allpay
      goStep(totalSteps+3);
      $('#afp_downpayment').html(hotel.currency+" "+finalInfo[3]);
      $('#afp_downpayment2').html(hotel.currency+" "+finalInfo[3]);
      console.log(finalInfo[8]);
      console.log(finalInfo[9]);
      console.log(finalInfo[10]);
      _payOtherUrl=finalInfo[8];
      if (finalInfo[9]!="") {
        _payOtherUrl+="/"+finalInfo[9];
      }
      if (finalInfo[10]!="" && finalInfo[10]!="hint") {
        _payOtherUrl+="&"+finalInfo[10];
      }
      $("#goallpay").attr("href",_payOtherUrl);
    } else if (payMethod>10) { //other pay
      goStep(totalSteps+2);
			var pageURL=window.location.href.toString();
      alert(imsgs(2)+finalInfo[6]);
			alert(imsgs(3));
      var url=payMObj.url;
      var parameters="";
      if (payMObj.p1!="") {
        parameters=payMObj.p1;
      }
      if (payMObj.p2!="") {
        if (parameters.length>0)
          parameters+="&";
        parameters+=payMObj.p2;
      }
      if (parameters.length>0)
        url+="?"+parameters;
			location.assign(url);
		}
	}
}

// 对Date的扩展，将 Date 转化为指定格式的String 
// 月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符， 
// 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字) 
// 例子： 
// (new Date()).Format("yyyy-MM-dd hh:mm:ss.S") ==> 2006-07-02 08:09:04.423 
// (new Date()).Format("yyyy-M-d h:m:s.S")      ==> 2006-7-2 8:9:4.18 
Date.prototype.Format = function(fmt) 
{ //author: meizz 
  var o = { 
    "M+" : this.getMonth()+1,                 //月份 
    "d+" : this.getDate(),                    //日 
    "h+" : this.getHours(),                   //小时 
    "m+" : this.getMinutes(),                 //分 
    "s+" : this.getSeconds(),                 //秒 
    "q+" : Math.floor((this.getMonth()+3)/3), //季度 
    "S"  : this.getMilliseconds()             //毫秒 
  }; 
  if(/(y+)/.test(fmt)) 
    fmt=fmt.replace(RegExp.$1, (this.getFullYear()+"").substr(4 - RegExp.$1.length)); 
  for(var k in o) 
    if(new RegExp("("+ k +")").test(fmt)) 
  fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length))); 
  return fmt; 
}
var imsgList = new Array();
var imsg_enList = new Array();
imsgList[0]="請進入您的支付寶APP或支付寶網站收銀台轉帳．\r\n";
imsg_enList[0]="Please login your Alipay to continue.\r\n";
imsgList[1]="系統已發出付款引導文件至您的信箱, 請至您的信箱收信並使用支付寶付款．";
imsg_enList[1]="Your reservation is completed, please check your email for confirmation.";
imsgList[2]="即將導入付款網頁入口．\r\n訂單編號=";
imsg_enList[2]="Redriect to a new page to continue.\r\nOrder No.=";
imsgList[3]="系統已發出付款引導文件至您的信箱, 請至您的信箱收信並確認完成付款．";
imsg_enList[3]="Your reservation is completed, please check your email for confirmation.";
imsgList[4]="對不起, 您要訂的房間剛剛已經被手腳更快的人訂走了, 請重新選擇房間。";
imsg_enList[4]="Sorry. Due to the delay of your reservation.\r\nThe rooms have been reserved by others.\r\nPlease re-choose the rooms.";
imsgList[5]="訂房失敗, 請檢查網路或於上班時間來電連絡我們。";
imsg_enList[5]="Reservation Failed. Please check your web connection or contact us between 9:00~18:00.";
imsgList[6]="前住付款";
imsg_enList[6]="To make payment";
imsgList[7]="請點我前往Paypal網站付款。";
imsg_enList[7]="Please click here to pay at Paypal";
imsgList[11]="請點我前往歐付寶網站付款。";
imsg_enList[11]="Please click here to pay at Allpay";
function imsgs(i) {
  if(langU=="en") return imsg_enList[i];
	else return imsgList[i];
}